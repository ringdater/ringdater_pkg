---
title: " RingdateR output log"
output:
  html_document:
    theme: cosmo
    toc: no
---
```{r run_info, echo = FALSE}

time <- Sys.time()
```

Run time: `r time`

```{r det_mode, echo = FALSE}
  det_val <- as.numeric(input$detrending_select)  

  if (det_val == 1){
    det_method = "No detrending applied"
  } else if (det_val == 2){
    det_method <- "Convert to z-scores"
  } else if (det_val == 3){
    det_method <- paste0(input$splinewindow, " year spline")
  } else if (det_val == 4){
    det_method <- "Mod. negative exponential"
  } else if (det_val == 5){
    det_method <- "Friedman"
  } else if (det_val == 6){
    det_method <- "ModHugershoff"
  } else if (det_val == 7){
    det_method <- "First difference"
  } else {det_method <- "no number"}
```

### Detrending settings applied:
Detrending mode: `r det_method`

Prewhitening: `r input$ARmod`

Log Transform:`r input$logT`

### Correlations between each series and the arithemtic mean chronology with replacement
(The sample being analysed is excluded from the chronology)

```{r test, echo = FALSE}
  chron_data <- chron_detrended$df_data
  head(chron_data)

```


```{r table, echo = FALSE}
  chron_data <- chron_detrended$df_data
  
  the_data<-correl_replace(chron_data)

  knitr::kable(the_data, floating.environment="sidewaystable", digits = 32)
```

### Chronology and EPS plots

EPS and Rbar window: `r input$rbar_wind_init` years with 50% overlap

```{r chron_plot, echo = FALSE, out.width = '100%'}


  if((input$chron_eval_EPS*1.5>nrow(chron_data)) | (input$chron_eval_EPS<=5))  {
    N.plot.dat<-NULL
  } else {
    N.plot.dat<-R_bar_EPS(the.data = chron_data, window = as.numeric(input$chron_eval_EPS))
  }

  
  plot1 <- plot_all_series(chron_data)
  
  if(is.null(N.plot.dat) || ncol(N.plot.dat)<2){
        plot2<-RingdateR_error_message(message="EPS and Rbar windowlength error.")

      } else {
      plot2<-ggplot()+
          geom_line(data=N.plot.dat, aes(x=N.plot.dat[,1], y=N.plot.dat[,4]), size=0.75, na.rm=TRUE)+
        geom_line(data=N.plot.dat, aes(x=N.plot.dat[,1], y=N.plot.dat[,5]), size=0.75, na.rm=TRUE, color="red") +
        R_dateR_theme(text.size = 8, line.width = 0.75,l=20)  +
        scale_x_continuous(breaks = x.scale.bar(round(min(chron_data[,1]),-1),round(max(chron_data[,1]),-1)), limits = c(min(chron_data[,1]),max(chron_data[,1]))) +
        geom_hline(yintercept = 0.85, colour = "red",linetype = 2, size=0.75) + ylab("Rbar and EPS") + xlab("Year")
    } 
g1 <- ggplotGrob(plot1)
g2<-  ggplotGrob(plot2)
g<-rbind(g1, g2, size = "first")
both <-  grid.draw(g)
both

  
```
  
### Potential problem samples

Window used to evaluate for problems: `r input$initiated_problems_bin` years (with 50% overlap)
  
```{r problems, echo = FALSE}
  probs <- prob_check(chron_data,
                      as.numeric(input$initiated_problems_bin))
  row.names(probs) <- 1:nrow(probs)
  
  knitr::kable(probs, floating.environment="sidewaystable")
  
```

### Distribution of aligned samples

```{r sample_dist, echo = FALSE, out.width = '100%', dpi = 120}
 plot_data <- dated_line_plot(chron_data) 

plot_1<-ggplot()+
      geom_line(data = plot_data, aes(x=plot_data[,3], y = plot_data[,2], group = plot_data[,1]), size = 0.75, colour = "black") +
      geom_point(data = plot_data, aes(x=plot_data[,3], y = plot_data[,2], group = plot_data[,1]), size = 0.75, colour = "black") +
      geom_text(data = plot_data, aes(x=max(plot_data[,3])+20, y = plot_data[,2], group = plot_data[,1], label = plot_data[,1]), size = 3) +
      R_dateR_theme(text.size = 8, line.width = 0.75, l=20) + xlab("Year") + ylab("Number of samples") +
      scale_x_continuous(breaks = x.scale.bar(round(min(plot_data[,3]), -1), round(max(plot_data[,3]), -1)))

print(plot_1)

```

## Overview of correlations between each series and the arithmetic mean chronology
```{r problem_sample_plots, echo = FALSE, out.width = '100%', fig.out = 6, dpi = 120}
 
  full_data <- chron_data
  
 for (i in 2:ncol(full_data)){

  sample <- full_data[,i]
  ex_sample <- full_data[,-c(1,i)]
  years <- full_data[,1]
  chron<-rowMeans(ex_sample, na.rm = TRUE)
  combined<-data.frame(years, chron, sample)
  colnames(combined) <- c("years", "chronology", colnames(full_data)[i])

  hm_plot <- heatmap_analysis(combined, colnames(combined)[2], colnames(combined)[3], neg_lag = -5, pos_lag = 5, win = 21, center = 0, complete = FALSE, sel_col_pal = 1, font_size = 8, axis_line_width = 0.75, plot_line = 1, leg_size = 1)

  combined<-subset(combined, complete.cases(combined))

  ln_plot <- line_plot(combined, colnames(combined)[2], colnames(combined)[3], lag = 0, text.size = 6, line.width = 0.75)

  g1 <- ggplotGrob(ln_plot)
  g2<-  ggplotGrob(hm_plot)

  g<-rbind(g1, g2,  size = "first")
  grid::grid.newpage()
  both <- grid.draw(g)

  print(colnames(combined)[3])
  print(both)

  combined<-NULL
 }

```
